# Test 6: Success - With Metadata
# Tests PDF/A conversion with metadata parameter

SetVariable: $testID = "TEST-006"
SetVariable: $testName = "Success Case - With PDF Metadata"
SetVariable: $$testsTotal = $$testsTotal + 1

# Check if container is empty
If: IsEmpty ( plutest::plu )
  SetVariable: $result = "SKIPPED - No PDF in container"
  SetVariable: $$testResults = $$testResults & $testID & " - " & $testName & ": " & $result & ¶
  Exit
EndIf

SetVariable: $outputPath = Get(DesktopPath) & "test_with_metadata_" & Get(CurrentTimestamp) & ".pdf"

# Create metadata JSON
SetVariable: $metadata = "{\"title\": \"Test PDF/A Document\",\"author\": \"FileMaker Test Suite\",\"subject\": \"PDF/A Conversion Test\",\"keywords\": \"test, pdf/a, xrechnung\"}"

# Call with metadata parameter
SetField: plutest::script_result = XRec_ConvertToPDFA ( plutest::plu ; $outputPath ; $metadata )

# Parse JSON response
SetVariable: $jsonResponse = plutest::script_result
SetVariable: $success = JSONGetElement ( $jsonResponse ; "success" )
SetVariable: $resultPath = JSONGetElement ( $jsonResponse ; "result" )
SetVariable: $errorMsg = JSONGetElement ( $jsonResponse ; "error" )

# Check results
If: $success = "true" or $success = true
  If: not IsEmpty ( $resultPath )
    SetVariable: $result = "✓ PASSED"
    SetVariable: $$testsPassed = $$testsPassed + 1
  Else
    SetVariable: $result = "✗ FAILED - Empty result path"
    SetVariable: $$testsFailed = $$testsFailed + 1
  EndIf
Else
  # Metadata might not be implemented yet
  SetVariable: $hasMetadata = PatternCount ( Lower($errorMsg) ; "metadata" ) > 0

  If: $hasMetadata
    SetVariable: $result = "⚠ PASSED (metadata not yet implemented)"
    SetVariable: $$testsPassed = $$testsPassed + 1
  Else
    SetVariable: $result = "✗ FAILED - " & $errorMsg
    SetVariable: $$testsFailed = $$testsFailed + 1
  EndIf
EndIf

# Log results
SetVariable: $$testResults = $$testResults & $testID & " - " & $testName & ": " & $result & ¶
SetField: plutest::test_log = plutest::test_log & ¶ & Get(CurrentTimestamp) & " | " & $testID & " | " & $result & ¶ & "Metadata: " & $metadata & ¶ & "Response: " & $jsonResponse & ¶
